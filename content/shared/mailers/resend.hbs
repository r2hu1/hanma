---
name: resend
description: Email sending utility using Resend API
dependencies:
  - resend@^4.7.0
files:
  - name: libs/mailers/resend.ts
---
import { Resend } from 'resend';

/**
 * Resend client configuration
 */
const resend = new Resend(process.env.RESEND_API_KEY);

const FROM_EMAIL = process.env.RESEND_FROM_EMAIL || 'onboarding@resend.dev';

/**
 * Email options interface
 */
interface SendEmailOptions {
  to: string | string[];
  subject: string;
  text?: string;
  html?: string;
  from?: string;
  replyTo?: string;
  cc?: string | string[];
  bcc?: string | string[];
  attachments?: Array<{
    filename: string;
    content: Buffer | string;
  }>;
}

/**
 * Send an email using Resend
 */
export const sendMail = async (options: SendEmailOptions) => {
  if (!process.env.RESEND_API_KEY) {
    throw new Error('RESEND_API_KEY environment variable is not set');
  }

  try {
    const { data, error } = await resend.emails.send({
      from: options.from || FROM_EMAIL,
      to: Array.isArray(options.to) ? options.to : [options.to],
      subject: options.subject,
      text: options.text,
      html: options.html,
      reply_to: options.replyTo,
      cc: options.cc ? (Array.isArray(options.cc) ? options.cc : [options.cc]) : undefined,
      bcc: options.bcc ? (Array.isArray(options.bcc) ? options.bcc : [options.bcc]) : undefined,
      attachments: options.attachments,
    });

    if (error) {
      console.error('[ERROR] Resend error:', error);
      throw new Error(error.message);
    }

    console.log(`[EMAIL] Email sent: ${data?.id}`);
    return data;
  } catch (error) {
    console.error('[ERROR] Failed to send email:', error);
    throw error;
  }
};

/**
 * Send batch emails (up to 100 emails per request)
 */
export const sendBatchEmails = async (
  emails: Array<Omit<SendEmailOptions, 'from'> & { from?: string }>
) => {
  const batch = emails.map((email) => ({
    from: email.from || FROM_EMAIL,
    to: Array.isArray(email.to) ? email.to : [email.to],
    subject: email.subject,
    text: email.text,
    html: email.html,
  }));

  const { data, error } = await resend.batch.send(batch);

  if (error) {
    console.error('[ERROR] Batch send error:', error);
    throw new Error(error.message);
  }

  return data;
};

/**
 * Common email templates
 */
export const templates = {
  passwordReset: (resetUrl: string, expiresIn = '1 hour') => ({
    subject: 'Reset Your Password',
    html: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2>Password Reset Request</h2>
        <p>You requested to reset your password. Click the button below to proceed:</p>
        <a href="${resetUrl}" style="display: inline-block; padding: 12px 24px; background: #007bff; color: white; text-decoration: none; border-radius: 4px;">
          Reset Password
        </a>
        <p style="margin-top: 20px; color: #666;">
          This link expires in ${expiresIn}. If you didn't request this, please ignore this email.
        </p>
      </div>
    `,
  }),

  welcome: (name: string, loginUrl: string) => ({
    subject: 'Welcome!',
    html: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2>Welcome, ${name}!</h2>
        <p>Thanks for signing up. We're excited to have you on board.</p>
        <a href="${loginUrl}" style="display: inline-block; padding: 12px 24px; background: #28a745; color: white; text-decoration: none; border-radius: 4px;">
          Get Started
        </a>
      </div>
    `,
  }),

  verifyEmail: (verifyUrl: string) => ({
    subject: 'Verify Your Email',
    html: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2>Verify Your Email</h2>
        <p>Please verify your email address by clicking the button below:</p>
        <a href="${verifyUrl}" style="display: inline-block; padding: 12px 24px; background: #007bff; color: white; text-decoration: none; border-radius: 4px;">
          Verify Email
        </a>
      </div>
    `,
  }),
};
