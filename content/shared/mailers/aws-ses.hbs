---
name: aws-ses
description: Email sending utility using AWS SES
dependencies:
  - "@aws-sdk/client-ses@^3.810.0"
files:
  - name: libs/mailers/aws-ses.ts
---
import {
  SESClient,
  SendEmailCommand,
  SendRawEmailCommand,
  SendBulkTemplatedEmailCommand,
} from '@aws-sdk/client-ses';

/**
 * SES client configuration
 */
const sesClient = new SESClient({
  region: process.env.AWS_REGION || 'us-east-1',
  credentials: process.env.AWS_ACCESS_KEY_ID
    ? {
        accessKeyId: process.env.AWS_ACCESS_KEY_ID,
        secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY || '',
      }
    : undefined, // Use IAM role if no credentials
});

const FROM_EMAIL = process.env.SES_FROM_EMAIL || 'noreply@example.com';

/**
 * Email options interface
 */
interface SendEmailOptions {
  to: string | string[];
  subject: string;
  text?: string;
  html?: string;
  from?: string;
  replyTo?: string[];
  cc?: string[];
  bcc?: string[];
}

/**
 * Send an email using AWS SES
 */
export const sendMail = async (options: SendEmailOptions) => {
  const toAddresses = Array.isArray(options.to) ? options.to : [options.to];

  const command = new SendEmailCommand({
    Source: options.from || FROM_EMAIL,
    Destination: {
      ToAddresses: toAddresses,
      CcAddresses: options.cc,
      BccAddresses: options.bcc,
    },
    Message: {
      Subject: {
        Data: options.subject,
        Charset: 'UTF-8',
      },
      Body: {
        ...(options.text && {
          Text: {
            Data: options.text,
            Charset: 'UTF-8',
          },
        }),
        ...(options.html && {
          Html: {
            Data: options.html,
            Charset: 'UTF-8',
          },
        }),
      },
    },
    ReplyToAddresses: options.replyTo,
  });

  try {
    const response = await sesClient.send(command);
    console.log(`[EMAIL] Email sent: ${response.MessageId}`);
    return response;
  } catch (error) {
    console.error('[ERROR] SES error:', error);
    throw error;
  }
};

/**
 * Send using SES template
 * Requires a pre-configured SES template
 */
export const sendWithTemplate = async (
  to: string | string[],
  templateName: string,
  templateData: Record<string, unknown>,
  options?: Partial<SendEmailOptions>
) => {
  const { SendTemplatedEmailCommand } = await import('@aws-sdk/client-ses');

  const command = new SendTemplatedEmailCommand({
    Source: options?.from || FROM_EMAIL,
    Destination: {
      ToAddresses: Array.isArray(to) ? to : [to],
    },
    Template: templateName,
    TemplateData: JSON.stringify(templateData),
    ReplyToAddresses: options?.replyTo,
  });

  try {
    const response = await sesClient.send(command);
    console.log(`[EMAIL] Template email sent: ${response.MessageId}`);
    return response;
  } catch (error) {
    console.error('[ERROR] SES template error:', error);
    throw error;
  }
};

/**
 * Send bulk emails (up to 50 destinations per request)
 */
export const sendBulkEmails = async (
  emails: Array<{
    to: string;
    templateData: Record<string, unknown>;
  }>,
  templateName: string,
  from?: string
) => {
  const command = new SendBulkTemplatedEmailCommand({
    Source: from || FROM_EMAIL,
    Template: templateName,
    DefaultTemplateData: JSON.stringify({}),
    Destinations: emails.map((email) => ({
      Destination: {
        ToAddresses: [email.to],
      },
      ReplacementTemplateData: JSON.stringify(email.templateData),
    })),
  });

  try {
    const response = await sesClient.send(command);
    console.log(`[EMAIL] Bulk sent: ${emails.length} emails`);
    return response;
  } catch (error) {
    console.error('[ERROR] SES bulk error:', error);
    throw error;
  }
};

/**
 * Common email templates
 */
export const templates = {
  passwordReset: (resetUrl: string, expiresIn = '1 hour') => ({
    subject: 'Reset Your Password',
    html: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2>Password Reset Request</h2>
        <p>You requested to reset your password. Click the button below to proceed:</p>
        <a href="${resetUrl}" style="display: inline-block; padding: 12px 24px; background: #007bff; color: white; text-decoration: none; border-radius: 4px;">
          Reset Password
        </a>
        <p style="margin-top: 20px; color: #666;">
          This link expires in ${expiresIn}. If you didn't request this, please ignore this email.
        </p>
      </div>
    `,
  }),

  welcome: (name: string, loginUrl: string) => ({
    subject: 'Welcome!',
    html: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2>Welcome, ${name}!</h2>
        <p>Thanks for signing up. We're excited to have you on board.</p>
        <a href="${loginUrl}" style="display: inline-block; padding: 12px 24px; background: #28a745; color: white; text-decoration: none; border-radius: 4px;">
          Get Started
        </a>
      </div>
    `,
  }),

  verifyEmail: (verifyUrl: string) => ({
    subject: 'Verify Your Email',
    html: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2>Verify Your Email</h2>
        <p>Please verify your email address by clicking the button below:</p>
        <a href="${verifyUrl}" style="display: inline-block; padding: 12px 24px; background: #007bff; color: white; text-decoration: none; border-radius: 4px;">
          Verify Email
        </a>
      </div>
    `,
  }),
};
