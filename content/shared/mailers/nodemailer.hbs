---
name: nodemailer
description: Email sending utility using Nodemailer with templates support
dependencies:
  - nodemailer@^7.0.5
devDependencies:
  - "@types/nodemailer@^6.4.17"
files:
  - name: libs/mailer.ts
---
import nodemailer, { Transporter } from 'nodemailer';

/**
 * Email configuration from environment variables
 */
const config = {
  host: process.env.SMTP_HOST || 'smtp.gmail.com',
  port: parseInt(process.env.SMTP_PORT || '587', 10),
  secure: process.env.SMTP_SECURE === 'true',
  auth: {
    user: process.env.SMTP_USER,
    pass: process.env.SMTP_PASS,
  },
  from: process.env.SMTP_FROM || 'noreply@example.com',
};

/**
 * Nodemailer transporter instance
 */
let transporter: Transporter | null = null;

/**
 * Initialize mail transporter
 */
export const initMailer = () => {
  if (!config.auth.user || !config.auth.pass) {
    console.warn('[WARN] SMTP credentials not configured, email disabled');
    return;
  }

  transporter = nodemailer.createTransport({
    host: config.host,
    port: config.port,
    secure: config.secure,
    auth: config.auth,
  });

  console.log('[OK] Mailer initialized');
};

/**
 * Verify SMTP connection
 */
export const verifyMailer = async (): Promise<boolean> => {
  if (!transporter) return false;
  
  try {
    await transporter.verify();
    return true;
  } catch (error) {
    console.error('[ERROR] SMTP verification failed:', error);
    return false;
  }
};

/**
 * Email options interface
 */
interface SendMailOptions {
  to: string | string[];
  subject: string;
  text?: string;
  html?: string;
  from?: string;
  replyTo?: string;
  attachments?: Array<{
    filename: string;
    content?: string | Buffer;
    path?: string;
  }>;
}

/**
 * Send an email
 */
export const sendMail = async (options: SendMailOptions) => {
  if (!transporter) {
    throw new Error('Mailer not initialized. Call initMailer() first.');
  }

  const mailOptions = {
    from: options.from || config.from,
    to: Array.isArray(options.to) ? options.to.join(', ') : options.to,
    subject: options.subject,
    text: options.text,
    html: options.html,
    replyTo: options.replyTo,
    attachments: options.attachments,
  };

  try {
    const info = await transporter.sendMail(mailOptions);
    console.log(`[EMAIL] Email sent: ${info.messageId}`);
    return info;
  } catch (error) {
    console.error('[ERROR] Failed to send email:', error);
    throw error;
  }
};

/**
 * Common email templates
 */
export const templates = {
  /**
   * Password reset email
   */
  passwordReset: (resetUrl: string, expiresIn = '1 hour') => ({
    subject: 'Reset Your Password',
    html: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2>Password Reset Request</h2>
        <p>You requested to reset your password. Click the button below to proceed:</p>
        <a href="${resetUrl}" style="display: inline-block; padding: 12px 24px; background: #007bff; color: white; text-decoration: none; border-radius: 4px;">
          Reset Password
        </a>
        <p style="margin-top: 20px; color: #666;">
          This link expires in ${expiresIn}. If you didn't request this, please ignore this email.
        </p>
      </div>
    `,
    text: `Reset your password: ${resetUrl}\n\nThis link expires in ${expiresIn}.`,
  }),

  /**
   * Welcome email
   */
  welcome: (name: string, loginUrl: string) => ({
    subject: 'Welcome!',
    html: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2>Welcome, ${name}!</h2>
        <p>Thanks for signing up. We're excited to have you on board.</p>
        <a href="${loginUrl}" style="display: inline-block; padding: 12px 24px; background: #28a745; color: white; text-decoration: none; border-radius: 4px;">
          Get Started
        </a>
      </div>
    `,
    text: `Welcome, ${name}!\n\nGet started: ${loginUrl}`,
  }),

  /**
   * Email verification
   */
  verifyEmail: (verifyUrl: string) => ({
    subject: 'Verify Your Email',
    html: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2>Verify Your Email</h2>
        <p>Please verify your email address by clicking the button below:</p>
        <a href="${verifyUrl}" style="display: inline-block; padding: 12px 24px; background: #007bff; color: white; text-decoration: none; border-radius: 4px;">
          Verify Email
        </a>
      </div>
    `,
    text: `Verify your email: ${verifyUrl}`,
  }),
};
