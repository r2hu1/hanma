---
name: sendgrid
description: Email sending utility using SendGrid API
dependencies:
  - "@sendgrid/mail@^8.1.5"
files:
  - name: libs/mailers/sendgrid.ts
---
import sgMail from '@sendgrid/mail';

/**
 * Initialize SendGrid with API key
 */
if (process.env.SENDGRID_API_KEY) {
  sgMail.setApiKey(process.env.SENDGRID_API_KEY);
}

const FROM_EMAIL = process.env.SENDGRID_FROM_EMAIL || 'noreply@example.com';

/**
 * Email options interface
 */
interface SendEmailOptions {
  to: string | string[];
  subject: string;
  text?: string;
  html?: string;
  from?: string;
  replyTo?: string;
  cc?: string | string[];
  bcc?: string | string[];
  attachments?: Array<{
    filename: string;
    content: string; // Base64 encoded
    type?: string;
    disposition?: 'attachment' | 'inline';
  }>;
  templateId?: string;
  dynamicTemplateData?: Record<string, unknown>;
}

/**
 * Send an email using SendGrid
 */
export const sendMail = async (options: SendEmailOptions) => {
  if (!process.env.SENDGRID_API_KEY) {
    throw new Error('SENDGRID_API_KEY environment variable is not set');
  }

  try {
    const msg: sgMail.MailDataRequired = {
      to: options.to,
      from: options.from || FROM_EMAIL,
      subject: options.subject,
      text: options.text,
      html: options.html,
      replyTo: options.replyTo,
      cc: options.cc,
      bcc: options.bcc,
      attachments: options.attachments,
      templateId: options.templateId,
      dynamicTemplateData: options.dynamicTemplateData,
    };

    const [response] = await sgMail.send(msg);
    console.log(`[EMAIL] Email sent: ${response.headers['x-message-id']}`);
    return response;
  } catch (error: any) {
    console.error('[ERROR] SendGrid error:', error.response?.body || error.message);
    throw error;
  }
};

/**
 * Send batch emails (up to 1000 recipients per request)
 */
export const sendBatchEmails = async (
  emails: Array<Omit<SendEmailOptions, 'from'> & { from?: string }>
) => {
  const messages = emails.map((email) => ({
    to: email.to,
    from: email.from || FROM_EMAIL,
    subject: email.subject,
    text: email.text,
    html: email.html,
    templateId: email.templateId,
    dynamicTemplateData: email.dynamicTemplateData,
  }));

  try {
    const responses = await sgMail.send(messages);
    console.log(`[EMAIL] Batch sent: ${messages.length} emails`);
    return responses;
  } catch (error: any) {
    console.error('[ERROR] Batch send error:', error.response?.body || error.message);
    throw error;
  }
};

/**
 * Send using SendGrid dynamic template
 */
export const sendWithTemplate = async (
  to: string | string[],
  templateId: string,
  dynamicData: Record<string, unknown>,
  options?: Partial<SendEmailOptions>
) => {
  return sendMail({
    to,
    subject: '', // Subject comes from template
    templateId,
    dynamicTemplateData: dynamicData,
    ...options,
  });
};

/**
 * Common email templates (for inline HTML, not SendGrid templates)
 */
export const templates = {
  passwordReset: (resetUrl: string, expiresIn = '1 hour') => ({
    subject: 'Reset Your Password',
    html: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2>Password Reset Request</h2>
        <p>You requested to reset your password. Click the button below to proceed:</p>
        <a href="${resetUrl}" style="display: inline-block; padding: 12px 24px; background: #007bff; color: white; text-decoration: none; border-radius: 4px;">
          Reset Password
        </a>
        <p style="margin-top: 20px; color: #666;">
          This link expires in ${expiresIn}. If you didn't request this, please ignore this email.
        </p>
      </div>
    `,
  }),

  welcome: (name: string, loginUrl: string) => ({
    subject: 'Welcome!',
    html: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2>Welcome, ${name}!</h2>
        <p>Thanks for signing up. We're excited to have you on board.</p>
        <a href="${loginUrl}" style="display: inline-block; padding: 12px 24px; background: #28a745; color: white; text-decoration: none; border-radius: 4px;">
          Get Started
        </a>
      </div>
    `,
  }),

  verifyEmail: (verifyUrl: string) => ({
    subject: 'Verify Your Email',
    html: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2>Verify Your Email</h2>
        <p>Please verify your email address by clicking the button below:</p>
        <a href="${verifyUrl}" style="display: inline-block; padding: 12px 24px; background: #007bff; color: white; text-decoration: none; border-radius: 4px;">
          Verify Email
        </a>
      </div>
    `,
  }),
};
