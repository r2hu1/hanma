---
name: mongoose-client
description: Mongoose ODM client setup with connection handling and example model
dependencies:
  - mongoose@^8.15.1
files:
  - name: libs/db/mongoose.ts
---
import mongoose from 'mongoose';

/**
 * Mongoose connection options
 */
const options: mongoose.ConnectOptions = {
  maxPoolSize: 20,
  minPoolSize: 5,
  serverSelectionTimeoutMS: 5000,
  socketTimeoutMS: 45000,
};

/**
 * Connect to MongoDB with retry logic
 */
export const connectDatabase = async (retries = 5, delay = 5000): Promise<void> => {
  const uri = process.env.MONGODB_URI || 'mongodb://localhost:27017/database';
  
  for (let i = 0; i < retries; i++) {
    try {
      await mongoose.connect(uri, options);
      console.log('[OK] MongoDB connected');
      return;
    } catch (error) {
      console.error(`[ERROR] MongoDB connection failed (attempt ${i + 1}/${retries})`);
      if (i < retries - 1) {
        await new Promise((r) => setTimeout(r, delay));
      }
    }
  }
  throw new Error('Failed to connect to MongoDB after retries');
};

/**
 * Disconnect from database (for graceful shutdown)
 */
export const disconnectDatabase = async (): Promise<void> => {
  await mongoose.disconnect();
  console.log('[INFO] MongoDB disconnected');
};

/**
 * Health check for database connection
 */
export const isDatabaseHealthy = async (): Promise<boolean> => {
  try {
    if (mongoose.connection.readyState !== 1) return false;
    await mongoose.connection.db?.admin().ping();
    return true;
  } catch {
    return false;
  }
};

/**
 * Connection event handlers
 */
mongoose.connection.on('error', (err) => {
  console.error('[ERROR] MongoDB connection error:', err);
});

mongoose.connection.on('disconnected', () => {
  console.log('[INFO] MongoDB disconnected');
});

mongoose.connection.on('reconnected', () => {
  console.log('[OK] MongoDB reconnected');
});

// ============================================
// Example User Model - Modify as needed
// ============================================

export interface IUser {
  email: string;
  name?: string;
  isDeleted?: boolean;
  createdAt?: Date;
  updatedAt?: Date;
}

const userSchema = new mongoose.Schema<IUser>(
  {
    email: { type: String, required: true, unique: true },
    name: { type: String },
    isDeleted: { type: Boolean, default: false }, // soft delete
  },
  {
    timestamps: true, // auto createdAt & updatedAt
    collection: 'users',
  }
);

// Exclude soft-deleted documents by default
userSchema.pre('find', function () {
  this.where({ isDeleted: { $ne: true } });
});

userSchema.pre('findOne', function () {
  this.where({ isDeleted: { $ne: true } });
});

export const User = mongoose.model<IUser>('User', userSchema);

// Export mongoose for advanced usage
export { mongoose };
