---
name: password-argon2
description: Secure password hashing using Argon2id (OWASP Recommended)
dependencies:
  - argon2@^0.43.0
files:
  - name: utils/password.ts
---
import argon2 from 'argon2';

/**
 * Argon2id configuration following OWASP recommendations:
 * - memoryCost: 65536 KB (64 MiB) - memory usage
 * - timeCost: 3 - number of iterations  
 * - parallelism: 4 - degree of parallelism
 * - hashLength: 32 bytes (256 bits)
 * 
 * These values provide strong security while remaining practical.
 * Adjust based on your server's capabilities.
 */
const ARGON2_OPTIONS: argon2.Options = {
  type: argon2.argon2id, // Hybrid mode, resistant to side-channel and GPU attacks
  memoryCost: 65536,     // 64 MiB
  timeCost: 3,
  parallelism: 4,
  hashLength: 32,
};

/**
 * Hash a password using Argon2id
 * @param password - Plain text password to hash
 * @returns Hashed password string
 */
export const encryptPassword = async (password: string): Promise<string> => {
  if (!password.length) {
    throw new Error('Password cannot be empty');
  }
  return argon2.hash(password, ARGON2_OPTIONS);
};

/**
 * Verify a password against its hash
 * Uses constant-time comparison internally
 * @param password - Plain text password to verify
 * @param hash - Previously hashed password
 * @returns True if password matches
 */
export const verifyPassword = async (password: string, hash: string): Promise<boolean> => {
  if (!password || !hash) {
    return false;
  }
  try {
    return await argon2.verify(hash, password);
  } catch {
    // Invalid hash format or other error
    return false;
  }
};

/**
 * Check if a hash needs to be rehashed (e.g., after updating options)
 * @param hash - Existing password hash
 * @returns True if the hash should be regenerated
 */
export const needsRehash = (hash: string): boolean => {
  return argon2.needsRehash(hash, ARGON2_OPTIONS);
};
