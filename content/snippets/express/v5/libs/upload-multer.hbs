---
name: express-upload-multer
description: Local file upload handling with Multer for Express

dependencies:
  "multer": "^1.4.5-lts.1"

devDependencies:
  "@types/multer": "^1.4.12"

files:
  - name: libs/upload.ts
---

import multer from "multer";
import path from "path";
import { Request } from "express";
import fs from "fs";
import crypto from "crypto";

// Ensure upload directory exists
const uploadDir = process.env.UPLOAD_DIR || "uploads";
if (!fs.existsSync(uploadDir)) {
  fs.mkdirSync(uploadDir, { recursive: true });
}

// Storage configuration
const storage = multer.diskStorage({
  destination: (_req, _file, cb) => {
    cb(null, uploadDir);
  },
  filename: (_req, file, cb) => {
    const uniqueSuffix = crypto.randomBytes(8).toString("hex");
    const ext = path.extname(file.originalname);
    cb(null, `${Date.now()}-${uniqueSuffix}${ext}`);
  },
});

// File filter for allowed types
const fileFilter = (
  _req: Request,
  file: Express.Multer.File,
  cb: multer.FileFilterCallback
) => {
  const allowedMimeTypes = [
    "image/jpeg",
    "image/png",
    "image/gif",
    "image/webp",
    "application/pdf",
    "text/plain",
    "application/json",
  ];

  if (allowedMimeTypes.includes(file.mimetype)) {
    cb(null, true);
  } else {
    cb(new Error(`File type ${file.mimetype} is not allowed`));
  }
};

// Default limits
const limits = {
  fileSize: 10 * 1024 * 1024, // 10MB
  files: 5,
};

// Create upload middleware
export const upload = multer({
  storage,
  fileFilter,
  limits,
});

// Preset configurations
export const uploadSingle = (fieldName: string = "file") =>
  upload.single(fieldName);

export const uploadMultiple = (fieldName: string = "files", maxCount = 5) =>
  upload.array(fieldName, maxCount);

export const uploadFields = (
  fields: { name: string; maxCount?: number }[]
) => upload.fields(fields);

// Memory storage (for processing without saving)
export const uploadMemory = multer({
  storage: multer.memoryStorage(),
  fileFilter,
  limits,
});

// Helper to delete uploaded file
export const deleteFile = (filePath: string): Promise<void> => {
  return new Promise((resolve, reject) => {
    fs.unlink(filePath, (err) => {
      if (err && err.code !== "ENOENT") {
        reject(err);
      } else {
        resolve();
      }
    });
  });
};

// Get file URL from request
export const getFileUrl = (req: Request, filename: string): string => {
  const protocol = req.protocol;
  const host = req.get("host");
  return `${protocol}://${host}/${uploadDir}/${filename}`;
};

// Usage:
/*
import { uploadSingle, uploadMultiple, getFileUrl } from "./libs/upload";

// Single file upload
app.post("/upload", uploadSingle("file"), (req, res) => {
  if (!req.file) {
    return res.status(400).json({ error: "No file uploaded" });
  }
  
  res.json({
    filename: req.file.filename,
    url: getFileUrl(req, req.file.filename),
    size: req.file.size,
  });
});

// Multiple files upload
app.post("/upload-multiple", uploadMultiple("files", 5), (req, res) => {
  const files = req.files as Express.Multer.File[];
  res.json({
    files: files.map(f => ({
      filename: f.filename,
      url: getFileUrl(req, f.filename),
    })),
  });
});
*/
