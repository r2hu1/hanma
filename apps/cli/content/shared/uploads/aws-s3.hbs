---
name: aws-s3-upload
description: AWS S3 file upload with presigned PUT URLs and POST policies for direct browser uploads
dependencies:
  - "@aws-sdk/client-s3"
  - "@aws-sdk/s3-request-presigner"
files:
  - name: libs/uploads/aws-s3.ts
---

import {
  S3Client,
  PutObjectCommand,
  GetObjectCommand,
  DeleteObjectCommand,
  HeadObjectCommand,
} from '@aws-sdk/client-s3';
import { getSignedUrl } from '@aws-sdk/s3-request-presigner';
import { createHash, randomBytes } from 'crypto';

/**
 * S3 client configuration
 */
const s3Client = new S3Client({
  region: process.env.AWS_REGION || 'us-east-1',
  credentials: process.env.AWS_ACCESS_KEY_ID
    ? {
        accessKeyId: process.env.AWS_ACCESS_KEY_ID,
        secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY || '',
      }
    : undefined, // Use IAM role if no credentials provided
});

const BUCKET = process.env.S3_BUCKET || '';

/**
 * Generate a unique file key with date-based organization
 */
const generateKey = (filename: string, folder = 'uploads'): string => {
  const ext = filename.split('.').pop() || '';
  const uniqueId = randomBytes(8).toString('hex');
  const date = new Date().toISOString().split('T')[0];
  return `${folder}/${date}/${uniqueId}.${ext}`;
};

/**
 * Generate a presigned PUT URL for direct browser upload
 * Client uploads file directly to S3 using PUT request
 * 
 * @example
 * // Server: Generate URL
 * const { uploadUrl, key } = await getPresignedPutUrl('image.png', 'image/png');
 * 
 * // Client: Upload file
 * await fetch(uploadUrl, { method: 'PUT', body: file, headers: { 'Content-Type': 'image/png' } });
 */
export const getPresignedPutUrl = async (
  filename: string,
  contentType: string,
  options: {
    expiresIn?: number; // seconds, default: 5 minutes
    folder?: string;
    maxSize?: number; // bytes
  } = {}
): Promise<{ uploadUrl: string; key: string; publicUrl: string }> => {
  const { expiresIn = 300, folder = 'uploads' } = options;
  const key = generateKey(filename, folder);

  const command = new PutObjectCommand({
    Bucket: BUCKET,
    Key: key,
    ContentType: contentType,
  });

  const uploadUrl = await getSignedUrl(s3Client, command, { expiresIn });
  const publicUrl = `https://${BUCKET}.s3.amazonaws.com/${key}`;

  return { uploadUrl, key, publicUrl };
};

/**
 * Generate a presigned POST policy for form-based uploads
 * Allows setting conditions like max file size, content type restrictions
 * 
 * @example
 * // Server: Generate policy
 * const policy = await getPresignedPostPolicy('image.png', 'image/', { maxSize: 5 * 1024 * 1024 });
 * 
 * // Client: Upload using FormData
 * const formData = new FormData();
 * Object.entries(policy.fields).forEach(([k, v]) => formData.append(k, v));
 * formData.append('file', file);
 * await fetch(policy.url, { method: 'POST', body: formData });
 */
export const getPresignedPostPolicy = async (
  filename: string,
  contentTypePrefix: string, // e.g., 'image/' to allow any image
  options: {
    expiresIn?: number; // seconds, default: 5 minutes
    folder?: string;
    maxSize?: number; // bytes, default: 10MB
  } = {}
): Promise<{
  url: string;
  fields: Record<string, string>;
  key: string;
  publicUrl: string;
}> => {
  const { createPresignedPost } = await import('@aws-sdk/s3-presigned-post');
  const { expiresIn = 300, folder = 'uploads', maxSize = 10 * 1024 * 1024 } = options;
  const key = generateKey(filename, folder);

  const { url, fields } = await createPresignedPost(s3Client, {
    Bucket: BUCKET,
    Key: key,
    Conditions: [
      ['content-length-range', 0, maxSize],
      ['starts-with', '$Content-Type', contentTypePrefix],
    ],
    Expires: expiresIn,
  });

  const publicUrl = `https://${BUCKET}.s3.amazonaws.com/${key}`;

  return { url, fields, key, publicUrl };
};

/**
 * Generate a presigned download URL for private files
 */
export const getPresignedDownloadUrl = async (
  key: string,
  expiresIn = 3600 // 1 hour default
): Promise<string> => {
  const command = new GetObjectCommand({
    Bucket: BUCKET,
    Key: key,
  });

  return getSignedUrl(s3Client, command, { expiresIn });
};

/**
 * Delete a file from S3
 */
export const deleteFile = async (key: string): Promise<void> => {
  await s3Client.send(
    new DeleteObjectCommand({
      Bucket: BUCKET,
      Key: key,
    })
  );
};

/**
 * Check if a file exists in S3
 */
export const fileExists = async (key: string): Promise<boolean> => {
  try {
    await s3Client.send(
      new HeadObjectCommand({
        Bucket: BUCKET,
        Key: key,
      })
    );
    return true;
  } catch {
    return false;
  }
};

/**
 * Get file metadata from S3
 */
export const getFileMetadata = async (key: string) => {
  const response = await s3Client.send(
    new HeadObjectCommand({
      Bucket: BUCKET,
      Key: key,
    })
  );

  return {
    contentType: response.ContentType,
    contentLength: response.ContentLength,
    lastModified: response.LastModified,
    etag: response.ETag,
  };
};

/**
 * Upload a file buffer directly (server-side upload)
 */
export const uploadFile = async (
  buffer: Buffer,
  filename: string,
  contentType: string,
  folder = 'uploads'
): Promise<{ key: string; url: string }> => {
  const key = generateKey(filename, folder);

  await s3Client.send(
    new PutObjectCommand({
      Bucket: BUCKET,
      Key: key,
      Body: buffer,
      ContentType: contentType,
    })
  );

  const url = `https://${BUCKET}.s3.amazonaws.com/${key}`;
  return { key, url };
};
