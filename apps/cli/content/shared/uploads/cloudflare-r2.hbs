---
name: cloudflare-r2-upload
description: Cloudflare R2 file upload with presigned URLs (S3-compatible API)
dependencies:
  - "@aws-sdk/client-s3"
  - "@aws-sdk/s3-request-presigner"
files:
  - name: libs/uploads/cloudflare-r2.ts
---
import {
  S3Client,
  PutObjectCommand,
  GetObjectCommand,
  DeleteObjectCommand,
  HeadObjectCommand,
} from '@aws-sdk/client-s3';
import { getSignedUrl } from '@aws-sdk/s3-request-presigner';
import { randomBytes } from 'crypto';

/**
 * Cloudflare R2 client configuration
 * R2 uses S3-compatible API
 * 
 * Required env vars:
 * - R2_ACCOUNT_ID: Cloudflare account ID
 * - R2_ACCESS_KEY_ID: R2 access key
 * - R2_SECRET_ACCESS_KEY: R2 secret key
 * - R2_BUCKET: Bucket name
 * - R2_PUBLIC_URL: (Optional) Custom domain or R2.dev URL for public access
 */
const r2Client = new S3Client({
  region: 'auto', // R2 uses 'auto' region
  endpoint: `https://${process.env.R2_ACCOUNT_ID}.r2.cloudflarestorage.com`,
  credentials: {
    accessKeyId: process.env.R2_ACCESS_KEY_ID || '',
    secretAccessKey: process.env.R2_SECRET_ACCESS_KEY || '',
  },
});

const BUCKET = process.env.R2_BUCKET || '';
const PUBLIC_URL = process.env.R2_PUBLIC_URL || ''; // e.g., https://files.example.com

/**
 * Generate a unique file key with date-based organization
 */
const generateKey = (filename: string, folder = 'uploads'): string => {
  const ext = filename.split('.').pop() || '';
  const uniqueId = randomBytes(8).toString('hex');
  const date = new Date().toISOString().split('T')[0];
  return `${folder}/${date}/${uniqueId}.${ext}`;
};

/**
 * Generate a presigned PUT URL for direct upload
 * 
 * @example
 * // Server: Generate URL
 * const { uploadUrl, key } = await getPresignedUploadUrl('image.png', 'image/png');
 * 
 * // Client: Upload file
 * await fetch(uploadUrl, { method: 'PUT', body: file, headers: { 'Content-Type': 'image/png' } });
 */
export const getPresignedUploadUrl = async (
  filename: string,
  contentType: string,
  options: {
    expiresIn?: number; // seconds, default: 5 minutes
    folder?: string;
  } = {}
): Promise<{ uploadUrl: string; key: string; publicUrl: string }> => {
  const { expiresIn = 300, folder = 'uploads' } = options;
  const key = generateKey(filename, folder);

  const command = new PutObjectCommand({
    Bucket: BUCKET,
    Key: key,
    ContentType: contentType,
  });

  const uploadUrl = await getSignedUrl(r2Client, command, { expiresIn });
  const publicUrl = PUBLIC_URL ? `${PUBLIC_URL}/${key}` : '';

  return { uploadUrl, key, publicUrl };
};

/**
 * Generate a presigned POST policy for form-based uploads
 * Allows setting conditions like max file size
 */
export const getPresignedPostPolicy = async (
  filename: string,
  contentTypePrefix: string,
  options: {
    expiresIn?: number; // seconds, default: 5 minutes
    folder?: string;
    maxSize?: number; // bytes, default: 10MB
  } = {}
): Promise<{
  url: string;
  fields: Record<string, string>;
  key: string;
  publicUrl: string;
}> => {
  const { createPresignedPost } = await import('@aws-sdk/s3-presigned-post');
  const { expiresIn = 300, folder = 'uploads', maxSize = 10 * 1024 * 1024 } = options;
  const key = generateKey(filename, folder);

  const { url, fields } = await createPresignedPost(r2Client, {
    Bucket: BUCKET,
    Key: key,
    Conditions: [
      ['content-length-range', 0, maxSize],
      ['starts-with', '$Content-Type', contentTypePrefix],
    ],
    Expires: expiresIn,
  });

  const publicUrl = PUBLIC_URL ? `${PUBLIC_URL}/${key}` : '';

  return { url, fields, key, publicUrl };
};

/**
 * Generate a presigned download URL
 */
export const getPresignedDownloadUrl = async (
  key: string,
  expiresIn = 3600 // 1 hour default
): Promise<string> => {
  const command = new GetObjectCommand({
    Bucket: BUCKET,
    Key: key,
  });

  return getSignedUrl(r2Client, command, { expiresIn });
};

/**
 * Delete a file from R2
 */
export const deleteFile = async (key: string): Promise<void> => {
  await r2Client.send(
    new DeleteObjectCommand({
      Bucket: BUCKET,
      Key: key,
    })
  );
};

/**
 * Check if a file exists
 */
export const fileExists = async (key: string): Promise<boolean> => {
  try {
    await r2Client.send(
      new HeadObjectCommand({
        Bucket: BUCKET,
        Key: key,
      })
    );
    return true;
  } catch {
    return false;
  }
};

/**
 * Get file metadata
 */
export const getFileMetadata = async (key: string) => {
  const response = await r2Client.send(
    new HeadObjectCommand({
      Bucket: BUCKET,
      Key: key,
    })
  );

  return {
    contentType: response.ContentType,
    contentLength: response.ContentLength,
    lastModified: response.LastModified,
    etag: response.ETag,
  };
};

/**
 * Upload a file buffer directly (server-side upload)
 */
export const uploadFile = async (
  buffer: Buffer,
  filename: string,
  contentType: string,
  folder = 'uploads'
): Promise<{ key: string; url: string }> => {
  const key = generateKey(filename, folder);

  await r2Client.send(
    new PutObjectCommand({
      Bucket: BUCKET,
      Key: key,
      Body: buffer,
      ContentType: contentType,
    })
  );

  const url = PUBLIC_URL ? `${PUBLIC_URL}/${key}` : key;
  return { key, url };
};
