---
name: elysia-basic
description: Production-ready Elysia server with Bun-native graceful shutdown, structured errors, and Swagger
dependencies:
  - elysia
  - "@elysiajs/swagger"
devDependencies:
  - "@types/bun"
files:
  - name: src/index.ts
---
import { Elysia, t } from "elysia";
import { swagger } from "@elysiajs/swagger";

const isProd = process.env.NODE_ENV === "production";


const getErrorMessage = (error: unknown): string => {
  if (error instanceof Error) return error.message;

  if (typeof error === "string") return error;

  if (
    typeof error === "object" &&
    error !== null &&
    "message" in error &&
    typeof (error as { message?: unknown }).message === "string"
  ) {
    return (error as { message: string }).message;
  }

  return "Unknown error";
};


export const startServer = () => {
  const app = new Elysia({ name: "production-api" })

    /* ----------------------------- */
    /* Error definitions             */
    /* ----------------------------- */
    .error({
      BadRequest: class BadRequest extends Error {},
      Unauthorized: class Unauthorized extends Error {},
      Forbidden: class Forbidden extends Error {},
      NotFound: class NotFound extends Error {},
    })

    /* ----------------------------- */
    /* Global error handler          */
    /* ----------------------------- */
    .onError(({ code, error, set }) => {
      const statusMap: Record<string, number> = {
        BadRequest: 400,
        Unauthorized: 401,
        Forbidden: 403,
        NotFound: 404,
        VALIDATION: 400,
        INTERNAL_SERVER_ERROR: 500,
      };

      set.status = statusMap[code] ?? 500;

      const message = getErrorMessage(error);

      if (!isProd || set.status >= 500) {
        console.error(`[${code}]`, error);
      }

      return {
        success: false,
        code,
        message:
          isProd && set.status === 500 ? "Internal Server Error" : message,
        timestamp: new Date().toISOString(),
      };
    });

  if (!isProd) {
    app.use(
      swagger({
        documentation: {
          info: {
            title: "Production API",
            version: "1.0.0",
          },
        },
      })
    );
  }

  app.get(
    "/health",
    () => ({
      status: "ok",
      uptime: Math.floor(Bun.nanoseconds() / 1e9),
      timestamp: new Date().toISOString(),
    }),
    {
      response: t.Object({
        status: t.String(),
        uptime: t.Number(),
        timestamp: t.String(),
      }),
    }
  );


  app.get("/", () => ({ message: "Elysia API is running" }), {
    response: t.Object({
      message: t.String(),
    }),
  });

  return app;
};


export const shutdown = async (app: Elysia, signal?: string) => {
  if (signal) {
    console.log(`${signal} received. Shutting down...`);
  }

  await app.stop();
};
