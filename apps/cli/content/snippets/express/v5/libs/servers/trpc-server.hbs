---
name: trpc-server
description: tRPC server setup with Express adapter
dependencies:
  - "@trpc/server"
  - zod
devDependencies:
  - "@types/node"
  - "@types/express"
files:
  - name: libs/servers/trpc-server.ts
---
import { initTRPC, TRPCError } from '@trpc/server';
import { createExpressMiddleware } from '@trpc/server/adapters/express';
import express from 'express';
import { z } from 'zod';

/**
 * Context creation function
 * Called for each request, provides context to all procedures
 */
const createContext = ({ req, res }: { req: express.Request; res: express.Response }) => {
  // Extract user from auth header if present
  // const token = req.headers.authorization?.split(' ')[1];
  // const user = token ? verifyToken(token) : null;
  
  return {
    req,
    res,
    // user,
  };
};

type Context = Awaited<ReturnType<typeof createContext>>;

/**
 * Initialize tRPC with context
 */
const t = initTRPC.context<Context>().create({
  errorFormatter({ shape, error }) {
    return {
      ...shape,
      data: {
        ...shape.data,
        // Add custom error data here
      },
    };
  },
});

/**
 * Reusable middleware
 */
const isAuthenticated = t.middleware(({ ctx, next }) => {
  // if (!ctx.user) {
  //   throw new TRPCError({ code: 'UNAUTHORIZED' });
  // }
  return next({
    ctx: {
      ...ctx,
      // user: ctx.user,
    },
  });
});

/**
 * Procedure builders
 */
export const router = t.router;
export const publicProcedure = t.procedure;
export const protectedProcedure = t.procedure.use(isAuthenticated);

/**
 * Example router with procedures
 */
const appRouter = router({
  // Health check
  health: publicProcedure.query(() => ({
    status: 'ok',
    timestamp: new Date().toISOString(),
  })),

  // Example public procedure
  hello: publicProcedure
    .input(z.object({ name: z.string().optional() }))
    .query(({ input }) => {
      return { greeting: `Hello ${input.name || 'World'}!` };
    }),

  // Example mutation
  createItem: publicProcedure
    .input(z.object({
      title: z.string().min(1).max(100),
      description: z.string().optional(),
    }))
    .mutation(async ({ input }) => {
      // Save to database
      const item = {
        id: Math.random().toString(36).slice(2),
        ...input,
        createdAt: new Date(),
      };
      return item;
    }),

  // Nested routers
  user: router({
    list: publicProcedure.query(() => {
      return [{ id: '1', name: 'John' }];
    }),
    byId: publicProcedure
      .input(z.object({ id: z.string() }))
      .query(({ input }) => {
        return { id: input.id, name: 'John' };
      }),
  }),
});

/**
 * Export type for client usage
 */
export type AppRouter = typeof appRouter;

/**
 * Create and start tRPC server with Express
 */
export const createTRPCServer = (port = 4000) => {
  const app = express();

  // Health check endpoint
  app.get('/health', (_req, res) => {
    res.json({ status: 'ok', timestamp: new Date().toISOString() });
  });

  // tRPC middleware
  app.use(
    '/trpc',
    createExpressMiddleware({
      router: appRouter,
      createContext,
      onError({ error, path }) {
        console.error(`[ERROR] tRPC error on ${path}:`, error.message);
      },
    })
  );

  const server = app.listen(port, () => {
    console.log(`tRPC server running at http://localhost:${port}/trpc`);
  });

  return { app, server, router: appRouter };
};

/**
 * Start the server
 */
if (require.main === module) {
  createTRPCServer();
}
