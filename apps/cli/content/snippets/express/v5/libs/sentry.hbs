---
name: sentry
description: Sentry error tracking and performance monitoring setup
dependencies:
  - "@sentry/node"
devDependencies:
  - "@types/express"
files:
  - name: libs/sentry.ts
---
import * as Sentry from '@sentry/node';
import { Express } from 'express';

/**
 * Initialize Sentry
 * Call this at the very beginning of your program, before any other imports!
 */
export const initSentry = () => {
  if (!process.env.SENTRY_DSN) {
    console.warn('[WARN] SENTRY_DSN not set, error tracking disabled');
    return;
  }

  Sentry.init({
    dsn: process.env.SENTRY_DSN,
    environment: process.env.NODE_ENV || 'development',
    release: process.env.npm_package_version,
    
    // Performance Monitoring
    tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
    
    // Only send errors in production
    enabled: process.env.NODE_ENV === 'production',

    // Add useful integrations for Express
    integrations: [
      // Sentry v8+ automatically adds many integrations
    ],
    
    // Filter sensitive data
    beforeSend(event) {
      if (event.request?.headers) {
        delete event.request.headers['authorization'];
        delete event.request.headers['cookie'];
        delete event.request.headers['x-api-key'];
      }
      return event;
    },
  });

  console.log('[OK] Sentry initialized');
};

/**
 * Setup Sentry error handler
 * Add this AFTER your routes, but BEFORE any other error handlers
 */
export const setupSentryErrorHandler = (app: Express) => {
  if (!process.env.SENTRY_DSN || process.env.NODE_ENV !== 'production') {
    return;
  }

  Sentry.setupExpressErrorHandler(app);
};

/**
 * Capture exception manually
 */
export const captureException = (error: Error, context?: Record<string, unknown>) => {
  Sentry.captureException(error, {
    extra: context,
  });
};

/**
 * Set user context for error tracking
 * Call this after user authentication
 */
export const setUser = (user: { id: string; email?: string; [key: string]: unknown }) => {
  Sentry.setUser(user);
};

/**
 * Clear user context (on logout)
 */
export const clearUser = () => {
  Sentry.setUser(null);
};

/**
 * Add breadcrumb for debugging
 */
export const addBreadcrumb = (message: string, category?: string, data?: Record<string, unknown>) => {
  Sentry.addBreadcrumb({
    message,
    category: category || 'custom',
    data,
    level: 'info',
  });
};

/**
 * Example usage in index.ts:
 * 
 * 1. Initialize first:
 * import { initSentry } from './libs/sentry';
 * initSentry();
 * 
 * 2. Setup app:
 * import express from 'express';
 * import { setupSentryErrorHandler } from './libs/sentry';
 * 
 * const app = express();
 * 
 * // Note: Request and Tracing handlers are now automatic in Sentry v8+ 
 * // if initSentry is called before app initialization.
 * 
 * // Your routes here
 * app.use('/api', routes);
 * 
 * // 3. Error handler (must be after routes)
 * setupSentryErrorHandler(app);
 * 
 * // Your custom error handler
 * app.use(errorHandler);
 */

