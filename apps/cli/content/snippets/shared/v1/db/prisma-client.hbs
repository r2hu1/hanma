---
name: prisma-client
description: Prisma ORM client setup with logging and connection handling
dependencies:
  - "@prisma/client"
devDependencies:
  - prisma
files:
  - name: libs/db/prisma.ts
---
import { PrismaClient } from '@prisma/client';

/**
 * Prisma client configuration
 * Logs queries in development, only errors in production
 */
const prismaClientSingleton = () => {
  return new PrismaClient({
    log:
      process.env.NODE_ENV === 'development'
        ? ['query', 'info', 'warn', 'error']
        : ['error'],
    errorFormat: 'pretty',
  });
};

// Prevent multiple instances in development (hot reloading)
declare global {
  var prisma: undefined | ReturnType<typeof prismaClientSingleton>;
}

export const prisma = globalThis.prisma ?? prismaClientSingleton();

if (process.env.NODE_ENV !== 'production') {
  globalThis.prisma = prisma;
}

/**
 * Connect to database with retry logic
 */
export const connectDatabase = async (retries = 5, delay = 5000) => {
  for (let i = 0; i < retries; i++) {
    try {
      await prisma.$connect();
      console.log('[OK] Database connected');
      return;
    } catch (error) {
      console.error(`[ERROR] Database connection failed (attempt ${i + 1}/${retries})`);
      if (i < retries - 1) {
        await new Promise((r) => setTimeout(r, delay));
      }
    }
  }
  throw new Error('Failed to connect to database after retries');
};

/**
 * Disconnect from database (for graceful shutdown)
 */
export const disconnectDatabase = async () => {
  await prisma.$disconnect();
  console.log('[INFO] Database disconnected');
};

/**
 * Health check for database connection
 */
export const isDatabaseHealthy = async (): Promise<boolean> => {
  try {
    await prisma.$queryRaw`SELECT 1`;
    return true;
  } catch {
    return false;
  }
};
