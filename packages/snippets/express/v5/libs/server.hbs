---
name: server
description: Production-ready HTTP server setup with graceful shutdown
dependencies:
  - express
  - cors
  - helmet
  - dotenv
  - winston
  - morgan
devDependencies:
  - "@types/node"
  - "@types/express"
  - "@types/cors"
  - "@types/morgan"
files:
  - name: server.ts
  - name: cors.ts
    source: ./cors.hbs
  - name: middleware/logger.ts
    source: ../middleware/logger.hbs
---
import http from "http";
import express from "express";
import { startSocketServer } from "@/libs/socket";
import { config } from "@/config";
import { corsMiddleware } from "../cors";
import router from "@/routes";
import { requestLogger, notFoundHandler, errorHandler } from "@/middlewares";
import { logRoutes } from "@/middlewares/app";

const app = express();
const server = http.createServer(app);
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(corsMiddleware);
app.use(requestLogger);

app.use(router);
app.use(notFoundHandler);
app.use(errorHandler);

logRoutes(app);

export const startServer = async () => {
  if (server.listening) {
    console.log("Server already running");
    return;
  }

  try {
    // Pass in your connections here

    server.listen(config.server.port, () => {
      console.log(
        `ðŸš€ Server running on http://localhost:${config.server.port}`
      );
      console.log(
        `ðŸ©º Health check: http://localhost:${config.server.port}/health`
      );
    });

    socketServer = startSocketServer(server);
  } catch (err) {
    console.error("Failed to start server:", err);
    process.exit(1);
  }
};

export const shutdown = async (signal: string) => {
  console.log(`\n${signal} received. Shutting down gracefully...`);

  // remove database connections, redis connections, etc.

  server.close(() => {
    console.log("HTTP server closed");
    if (socketServer && typeof socketServer.close === "function") {
      socketServer.close();
      console.log("Socket server closed");
    }
    process.exit(0);
  });

  // Force shutdown after 10s
  setTimeout(() => {
    console.warn(
      `Grace period expired. Forcing close of ${sockets.size} remaining connection(s).`
    );
    sockets.forEach((socket) => socket.destroy());
    process.exit(1);
  }, 10000).unref();
};